<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·è€…å‹å–„ å½±ç‰‡å‰ªè¼¯å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.0/wavesurfer.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: left;
            background-color: #2D2D2D;
            overflow-y:hidden;
            overflow-x:hidden;
        }
        #videoPlayer {
            position: fixed;
            top: 15vh;
            bottom: 15vh;
            left: 15vw;
            right: 15vw;
            width: 70vw;
            height: 70vh;
            object-fit: contain;
            z-index: 1;
        }
        /*video {
            width: 90vw;*/
            /*max-width: 600vw;*/
            /*margin: 10vw 0;
        }*/
        .tooldeskTop
        {
            /*margin-left:5vw;
            margin-right:5vw;
            max-height:95vh;
            overflow-y:auto;
            overflow-x:hidden;  */ 
            position: fixed;
            top: 0;
            right: 15vw;
            left: 15vw;
            width: 70vw;
            height: 15vh;
            overflow-y: auto;
            padding: 2vw;
            background-color: rgba(45, 45, 45, 0.85);
            z-index: 2;
            items-align:center;
        }
        .tooldeskRight
        {
            /*margin-left:5vw;
            margin-right:5vw;
            max-height:95vh;
            overflow-y:auto;
            overflow-x:hidden;  */ 
            position: fixed;
            top: 0;
            right: 0;  
            width: 15vw;
            height: 100vh;
            overflow-y: auto;
            padding: 2vw;
            background-color: rgba(45, 45, 45, 0.85);
            z-index: 2;
            vertical-align:middle;            
        }
        .tooldeskLeft
        {
            /*margin-left:5vw;
            margin-right:5vw;
            max-height:95vh;
            overflow-y:auto;
            overflow-x:hidden;  */ 
            position: fixed;
            top: 0;
            left: 0;
            width: 15vw;
            height: 100vh;
            overflow-y: auto;
            padding: 2vw;
            background-color: rgba(45, 45, 45, 0.85);
            z-index: 2;
            vertical-align:middle;
        }
        .tooldeskBottom
        {
            /*margin-left:5vw;
            margin-right:5vw;
            max-height:95vh;
            overflow-y:auto;
            overflow-x:hidden;  */ 
            position: fixed;
            bottom: 0;
            right: 15vw;
            left: 15vw;
            width: 70vw;
            height: 15vh;
            overflow-y: auto;
            padding: 2vw;
            background-color: rgba(45, 45, 45, 0.85);
            z-index: 2;
        }
        .tooldesk * {
            display: block;
            margin-bottom: 2vw;
        }
        #videoInput
        {
            color:#FDF6E3;
            width: 100%;
        }
        .titleName {
            font-size: 6vw;
            color:#FDF6E3;
            font-weight:bolder;
            width:100%;            
        }
        .methodName {
            font-size: 8vw;
            color:#FDF6E3;
            font-weight:bolder;
            width:100%;   
        }
        .functionName {
            font-size: 7vw;
            color:#2D2D2D;
            width:35vw;
            text-align:center;
            background-color:#FDF6E3;
            display:inline-block;
            font-weight:bolder;
            cursor: pointer;
        }
        .functionPanel
        {
            height:0px;
            visibility:hidden;
            border: #FDF6E3 0.5vw solid;    
            font-weight:bolder;
        }

        button {
            font-size: 5vw;
            padding: 0.5vw;
            margin: 1vw;
            width: 35vw;
            border: #FDF6E3 0.5vw solid;
            background-color: #2D2D2D;
            color: #FDF6E3;
            border-radius: 3vw;
            cursor: pointer;
            margin-left:0px;
            font-weight:bolder;
        }
        input[type=number] {
            font-size: 4vw;
            padding: 0.5vw;
            margin: 1vw;
            width: 20vw;
            border: none;
            background-color: #F0EAD6;
            color: #2D2D2D;
            border-radius: 3vw;
            cursor: pointer;
            text-align:right;
            font-weight:bolder;
        }

        .hidden { display: none; }
        .subtitle-box {
            margin-top: 20vw;
        }
        #subtitlePreview {
            background: black;
            color: yellow;
            font-size: 20vw;
            padding: 5vw;
            display: inline-block;
        }
        .audio-visualizer {
            width: 90vw;
            height: 10vw;
            background-color: #ddd;
        }
        label
        {
            color:#FDF6E3;
            font-size: 4vw;
            font-weight:bolder;
        }



        #exportBtn
        {
            width: 100%;
            font-weight:bolder;
        }
    </style>
</head>
<body>
     <video id="videoPlayer" controls></video>  
    <div class="tooldeskTop">
        <span class="titleName">é•·è€…å‹å–„ å½±ç‰‡å‰ªè¼¯å™¨</span>
        <hr>
        <span id="output" class="methodName"></span>
        <!-- A. åŒ¯å…¥å½±ç‰‡ -->
        <input type="file" id="videoInput" accept="video/*">            
        <button id="exportBtn">ğŸ“¤å®Œæˆ</button> 
        <a id="downloadLink" class="hidden" download="output.mp4">ğŸ“¥ä¸‹è¼‰</a>
    </div>
    <div class="tooldeskRight">                
        <span class="functionName toogletitle_1" onclick="toggleSelect('1');" >âœ‚ï¸å‰ªè¼¯</span><br>
        <div class="functionPanel toogletarget_1" >            
            <label>é–‹å§‹æ™‚é–“(ç§’)<input type="number" id="startTime" min="0" value="0"></label>
            <br>
            <label>çµæŸæ™‚é–“(ç§’)<input type="number" id="endTime" min="0" value="5"></label>
            <br>
            <button id="trimBtn">âœ‚ï¸</button>
            <!--<a id="downloadLink" class="hidden" download="output.mp4">ğŸ“¥ä¸‹è¼‰</a>-->
        </div>
        <span class="functionName toogletitle_2"  onclick="toggleSelect('2');">ğŸ’¬å­—å¹•</span>
        <div class="functionPanel toogletarget_2" >
            <button id="addSubtitlesBtn">é–‹å§‹</button>
            <div id="subtitleSection" class="subtitle-box hidden">
                <label>å­—å¹•å…§å®¹<input type="text" id="subtitleText"></label>
                <label>é–‹å§‹æ™‚é–“(ç§’)<input type="number" id="subtitleStart" min="0"></label>
                <label>çµæŸæ™‚é–“(ç§’)<input type="number" id="subtitleEnd" min="0"></label>
                <button id="applySubtitlesBtn">æ–°å¢</button>
                <ul id="subtitleList"></ul>
            </div>
            <button id="generateSubtitledVideo">ğŸ“¼ç”¢ç”Ÿå­—å¹•</button>
            <a id="subtitledDownloadLink" class="hidden" download="subtitled.mp4">ğŸ“¥ä¸‹è¼‰</a>
            <br>
            <label>ğŸ“ºé è¦½</label>
            <br>
            <div id="subtitlePreview"></div>
        </div>
    </div>
    <div class="tooldeskLeft">
        <span class="functionName toogletitle_3"  onclick="toggleSelect('3');">ğŸµéŸ³æ¨‚</span>
        <div class="functionPanel toogletarget_3" >
            <button id="addMusicBtn">ğŸµåŠ éŸ³æ¨‚</button>
        </div>
        <span class="functionName toogletitle_4"  onclick="toggleSelect('4');">ğŸ™æ—ç™½</span>
        <div class="functionPanel toogletarget_4" >    
        <button id="addNarrationBtn">ğŸ™åŠ æ—ç™½</button>
        </div>
        <span class="functionName toogletitle_5"  onclick="toggleSelect('5');">âœ¨ç‰¹æ•ˆ</span>
        <div class="functionPanel toogletarget_5" > 
            <button id="effectsBtn">âœ¨åŠ ç‰¹æ•ˆ</button>
        </div>
    </div>
    <div class="tooldeskBottom">
        <!-- èªéŸ³è­˜åˆ¥ -->
        <span class="functionName toogletitle_6" onclick="toggleSelect('6');" >ğŸ™ï¸èªéŸ³è­˜åˆ¥</span><br>
        <div class="functionPanel toogletarget_6" >         
        <button id="voiceControlBtn">ğŸ™èªéŸ³æ§åˆ¶</button><br>
        </div>
         <!-- éŸ³é »è¦–è¦ºåŒ– -->  
        <span class="functionName toogletitle_7" onclick="toggleSelect('7');" >ğŸ¶éŸ³é »è¦–è¦ºåŒ–</span><br>
        <div class="functionPanel toogletarget_7" >         
        <div id="waveform" class="audio-visualizer"></div>
        </div>
    </div>
    <script>
        console.log("20250323-1207");
        function toggleSelect(item)
        {
            console.log("toggle");
            console.log(item);
            console.log(document.getElementsByClassName("toogletarget_" + item)[0].style.height);
            if(document.getElementsByClassName("toogletarget_" + item)[0].style.height!="0px" && document.getElementsByClassName("toogletarget_" + item)[0].style.height!="")
            {
                document.getElementsByClassName("toogletarget_" + item)[0].style.height="0px";
                 document.getElementsByClassName("toogletarget_" + item)[0].style.visibility="hidden";
            }
            else
            {
                document.getElementsByClassName("toogletarget_" + item)[0].style.height="auto";
                document.getElementsByClassName("toogletarget_" + item)[0].style.visibility="visible";
            }
        }
        document.addEventListener("DOMContentLoaded", async () => {
            function getQueryParams() {
                let params = new URLSearchParams(window.location.search);
                let name = params.get("functionSelect");
                let method = "";
                console.log(name);
                if(name.indexOf("eye") >-1)
                {
                    method = "è¦–è¦º";
                }
                if(name.indexOf("ear") >-1)
                {
                    if(method != "")
                    {
                        method += "+";
                    }
                    method += "è½è¦º";
                }
                if(name.indexOf("hand") >-1)
                {
                    if(method != "")
                    {
                        method += "+";
                    }
                    method += "è§¸è¦º";
                }
                document.getElementById("output").innerText = `${method}æ¨¡å¼`;
            }            
            // å‘¼å«å‡½å¼ä¾†é¡¯ç¤ºåƒæ•¸
            getQueryParams();
            const { createFFmpeg, fetchFile } = window.FFmpeg;
            const ffmpeg = createFFmpeg({ log: true });
            const videoInput = document.getElementById('videoInput');
            const videoPlayer = document.getElementById('videoPlayer');
            const trimBtn = document.getElementById('trimBtn');
            const downloadLink = document.getElementById('downloadLink');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const addSubtitlesBtn = document.getElementById('addSubtitlesBtn');
            const subtitleSection = document.getElementById('subtitleSection');
            const subtitleText = document.getElementById('subtitleText');
            const subtitleStart = document.getElementById('subtitleStart');
            const subtitleEnd = document.getElementById('subtitleEnd');
            const applySubtitlesBtn = document.getElementById('applySubtitlesBtn');
            const subtitleList = document.getElementById('subtitleList');
            const generateSubtitledVideo = document.getElementById('generateSubtitledVideo');
            const subtitledDownloadLink = document.getElementById('subtitledDownloadLink');
            const subtitlePreview = document.getElementById('subtitlePreview');
            const voiceControlBtn = document.getElementById('voiceControlBtn');
            const exportBtn = document.getElementById('exportBtn');
            const addMusicBtn = document.getElementById('addMusicBtn');
            const effectsBtn = document.getElementById('effectsBtn');
            const waveSurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'blue',
                progressColor: 'red',
                height: 80
            });            
            let videoFile = null;
            let subtitles = [];
            videoInput.addEventListener('change', () => {
                videoFile = videoInput.files[0];
                const videoURL = URL.createObjectURL(videoFile);
                videoPlayer.src = videoURL;
            });
            effectsBtn.addEventListener("click", async () => {
                if (!videoFile) {
                    alert("è«‹å…ˆå‰ªè¼¯å½±ç‰‡ï¼");
                    return;
                }
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));
        
                // åŠ ä¸€å€‹ç°¡å–®ç‰¹æ•ˆï¼šé»‘ç™½è™•ç†ï¼ˆä½ ä¹Ÿå¯ä»¥æ›æˆå…¶ä»– FFmpeg æ¿¾é¡ï¼‰
                await ffmpeg.run('-i', 'input.mp4', '-vf', 'hue=s=0', '-c:a', 'copy', 'effect.mp4');
        
                const data = ffmpeg.FS('readFile', 'effect.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                videoPlayer.src = url;
                videoPlayer.load();
                videoPlayer.play();
        
                videoFile = new File([data.buffer], "effect.mp4", { type: "video/mp4" });
            });
            addMusicBtn.addEventListener("click", async () => {
                if (!videoFile) {
                    alert("è«‹å…ˆå‰ªè¼¯å½±ç‰‡ï¼");
                    return;
                }
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));
                // å‡è¨­å…§å»ºä¸€å€‹éŸ³æ¨‚æª” bgm.mp3ï¼Œä¹Ÿå¯ä»¥æ”¹æˆ input ä¸Šå‚³æ–¹å¼
                const bgmResponse = await fetch('bgm.mp3'); // è«‹è‡ªè¡Œæä¾›
                const bgmBlob = await bgmResponse.blob();
                ffmpeg.FS('writeFile', 'bgm.mp3', await fetchFile(bgmBlob));
                    
                await ffmpeg.run('-i', 'input.mp4', '-i', 'bgm.mp3', '-c:v', 'copy', '-c:a', 'aac', '-shortest', 'music.mp4');
                    
                const data = ffmpeg.FS('readFile', 'music.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                videoPlayer.src = url;
                videoPlayer.load();
                videoPlayer.play();
                    
                videoFile = new File([data.buffer], "music.mp4", { type: "video/mp4" });
            });
    
            exportBtn.addEventListener("click", () => {
                if (!videoFile) {
                    alert("å°šæœªæœ‰å¯ä¸‹è¼‰çš„å½±ç‰‡");
                    return;
                }
                const finalUrl = URL.createObjectURL(videoFile);
                const link = document.createElement("a");
                link.href = finalUrl;
                link.download = "final_output.mp4";
                link.click();
            });
            trimBtn.addEventListener('click', async () => {
                if (!videoFile) {
                    alert("è«‹å…ˆä¸Šå‚³å½±ç‰‡ï¼");
                    return;
                }
                await ffmpeg.load();
                //const videoFile = videoInput.files[0];
                //if (!videoFile) {
                //    alert("è«‹å…ˆä¸Šå‚³å½±ç‰‡ï¼");
                //    return;
                //}
    
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));
                const start = startTimeInput.value;
                const end = endTimeInput.value;
                //await ffmpeg.run('-i', 'input.mp4', '-ss', '00:00:05', '-to', '00:00:10', '-c', 'copy', 'output.mp4');
                await ffmpeg.run('-i', 'input.mp4', '-ss', start, '-to', end, '-c', 'copy', 'output.mp4');
    
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                //downloadLink.href = url;
                //downloadLink.classList.remove('hidden');
                videoPlayer.src = url;
                videoPlayer.load();
                videoPlayer.play();
                videoFile = new File([data.buffer], "output.mp4", { type: "video/mp4" });
            });
            addSubtitlesBtn.addEventListener('click', () => {
                //subtitleSection.style.display = "block";
                subtitleSection.classList.toggle("hidden");
            });
    
            applySubtitlesBtn.addEventListener('click', () => {
                const text = subtitleText.value;
                const start = subtitleStart.value;
                const end = subtitleEnd.value;
    
                subtitles.push({ text, start, end });
                
                 let listItem = document.createElement("li");
                listItem.textContent = `(${start}s - ${end}s) ${text}`;
                subtitleList.appendChild(listItem);
            });
    
            generateSubtitledVideo.addEventListener('click', async () => {
                if (!videoFile) {
                    alert("è«‹å…ˆä¸Šå‚³å½±ç‰‡ï¼");
                    return;
                }
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));
    
                 let srtContent = subtitles.map((sub, index) => {
                    let startTime = new Date(sub.start * 1000).toISOString().substr(11, 8).replace('.', ',');
                    let endTime = new Date(sub.end * 1000).toISOString().substr(11, 8).replace('.', ',');
                    return `${index + 1}\n${startTime} --> ${endTime}\n${sub.text}\n`;
                }).join("\n");
    
                ffmpeg.FS('writeFile', 'subtitles.srt', new TextEncoder().encode(srtContent));
                await ffmpeg.run('-i', 'input.mp4', '-vf', 'subtitles=subtitles.srt:force_style="Fontsize=24,PrimaryColour=&H00FFFF00"','-c:v', 'libx264', '-c:a', 'copy', 'subtitled.mp4');
    
                const data = ffmpeg.FS('readFile', 'subtitled.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                subtitledDownloadLink.href = url;
                subtitledDownloadLink.classList.remove('hidden');
            });
    
            voiceControlBtn.addEventListener('click', () => {
                alert("èªéŸ³è­˜åˆ¥å°šæœªå•Ÿç”¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥å­—å¹•ï¼");
            });
    
            // ğŸ¤ èªéŸ³è­˜åˆ¥
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = "zh-TW";
    
                recognition.onresult = function(event) {
                    const speechResult = event.results[0][0].transcript;
                    console.log("èªéŸ³æŒ‡ä»¤ï¼š", speechResult);
    
                    if (speechResult.includes("å‰ªè¼¯å½±ç‰‡")) {
                        trimBtn.click();
                    } else if (speechResult.includes("å­—å¹•")) {
                        addSubtitlesBtn.click();
                    } else if (speechResult.match(/å¾(\d+)ç§’åˆ°(\d+)ç§’å‰ªè¼¯/)) {
                        const match = speechResult.match(/å¾(\d+)ç§’åˆ°(\d+)ç§’å‰ªè¼¯/);
                        startTimeInput.value = match[1];
                        endTimeInput.value = match[2];
                        trimBtn.click();
                    } else {
                        alert("æœªè­˜åˆ¥çš„æŒ‡ä»¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼");
                    }
                };
    
                voiceControlBtn.addEventListener('click', () => {
                    recognition.start();
                    alert("è«‹èªªå‡ºæ‚¨çš„æŒ‡ä»¤ï¼Œå¦‚ã€Œå¾ 5 ç§’åˆ° 10 ç§’å‰ªè¼¯ã€æˆ–ã€Œæ·»åŠ å­—å¹•ã€");
                });
            } else {
                voiceControlBtn.disabled = true;
                alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ§åˆ¶");
            }            
        });

    </script>
</body>
</html>
