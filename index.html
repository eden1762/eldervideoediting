<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·è€…å‹å–„ å½±ç‰‡å‰ªè¼¯èˆ‡å­—å¹•</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
        }
        h2 {
            font-size: 24px;
        }
        button, input {
            font-size: 18px;
            padding: 12px;
            margin: 10px;
            width: 80%;
            max-width: 300px;
            border: none;
            background-color: #007BFF;
            color: white;
            border-radius: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        video {
            width: 90%;
            max-width: 600px;
            margin: 10px 0;
        }
        .hidden { display: none; }
        .subtitle-box {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h2>ğŸ¥ é•·è€…å‹å–„ å½±ç‰‡å‰ªè¼¯èˆ‡å­—å¹•</h2>

    <!-- A. åŒ¯å…¥å½±ç‰‡ -->
    <input type="file" id="videoInput" accept="video/*">
    <video id="videoPlayer" controls></video>

    <!-- å­—å¹•æ·»åŠ å€ -->
    <h3>ğŸ’¬ æ·»åŠ å­—å¹•</h3>
    <button id="addSubtitlesBtn">é–‹å§‹æ·»åŠ å­—å¹•</button>
    <div id="subtitleSection" class="subtitle-box hidden">
        <label>å­—å¹•å…§å®¹: <input type="text" id="subtitleText"></label>
        <label>é–‹å§‹æ™‚é–“ (ç§’): <input type="number" id="subtitleStart" min="0"></label>
        <label>çµæŸæ™‚é–“ (ç§’): <input type="number" id="subtitleEnd" min="0"></label>
        <button id="applySubtitlesBtn">æ–°å¢å­—å¹•</button>
        <ul id="subtitleList"></ul>
    </div>

    <button id="generateSubtitledVideo">ğŸ“¼ ç”¢ç”Ÿå«å­—å¹•å½±ç‰‡</button>
    <a id="subtitledDownloadLink" class="hidden" download="subtitled.mp4">ğŸ“¥ ä¸‹è¼‰å«å­—å¹•å½±ç‰‡</a>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const { createFFmpeg, fetchFile } = window.FFmpeg;
            const ffmpeg = createFFmpeg({ log: true });

            const videoInput = document.getElementById('videoInput');
            const videoPlayer = document.getElementById('videoPlayer');
            const addSubtitlesBtn = document.getElementById('addSubtitlesBtn');
            const subtitleSection = document.getElementById('subtitleSection');
            const subtitleText = document.getElementById('subtitleText');
            const subtitleStart = document.getElementById('subtitleStart');
            const subtitleEnd = document.getElementById('subtitleEnd');
            const applySubtitlesBtn = document.getElementById('applySubtitlesBtn');
            const subtitleList = document.getElementById('subtitleList');
            const generateSubtitledVideo = document.getElementById('generateSubtitledVideo');
            const subtitledDownloadLink = document.getElementById('subtitledDownloadLink');

            let videoFile = null;
            let subtitles = [];

            videoInput.addEventListener('change', () => {
                videoFile = videoInput.files[0];
                videoPlayer.src = URL.createObjectURL(videoFile);
            });

            addSubtitlesBtn.addEventListener('click', () => {
                subtitleSection.classList.toggle("hidden");
            });

            applySubtitlesBtn.addEventListener('click', () => {
                const text = subtitleText.value;
                const start = subtitleStart.value;
                const end = subtitleEnd.value;

                subtitles.push({ text, start, end });

                let listItem = document.createElement("li");
                listItem.textContent = `(${start}s - ${end}s) ${text}`;
                subtitleList.appendChild(listItem);
            });

            generateSubtitledVideo.addEventListener('click', async () => {
                if (!videoFile) {
                    alert("è«‹å…ˆä¸Šå‚³å½±ç‰‡ï¼");
                    return;
                }
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));

                // ä¿®æ­£ SRT å­—å¹•æ ¼å¼
                let srtContent = subtitles.map((sub, index) => {
                    let startTime = new Date(sub.start * 1000).toISOString().substr(11, 8).replace('.', ',');
                    let endTime = new Date(sub.end * 1000).toISOString().substr(11, 8).replace('.', ',');
                    return `${index + 1}\n${startTime} --> ${endTime}\n${sub.text}\n`;
                }).join("\n");

                ffmpeg.FS('writeFile', 'subtitles.srt', new TextEncoder().encode(srtContent));

                // ä¿®æ­£ FFmpeg æŒ‡ä»¤ï¼Œç¢ºä¿å­—å¹•æ­£å¸¸æ‡‰ç”¨
                await ffmpeg.run('-i', 'input.mp4', '-vf', 
                    "subtitles=subtitles.srt:force_style='Fontsize=24,PrimaryColour=&H00FFFF00'", 
                    '-c:v', 'libx264', '-c:a', 'copy', 'subtitled.mp4');

                const data = ffmpeg.FS('readFile', 'subtitled.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                subtitledDownloadLink.href = url;
                subtitledDownloadLink.classList.remove('hidden');
            });

        });
    </script>

</body>
</html>
